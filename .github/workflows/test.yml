name: Tests
on: [pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync
      - run: uv run pytest
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t telecalbot:ci .
      - run: |
          docker run --rm \
            -e TELEGRAM_BOT_TOKEN=123:ABC \
            -e CALCOM_API_KEY=dummy \
            -e ADMIN_TELEGRAM_ID=1 \
            -e DATABASE_PATH=/tmp/telecalbot.db \
            telecalbot:ci \
            /app/.venv/bin/python -c "import app.main; print('import-ok')"
      - run: |
          docker run --rm \
            -e TELEGRAM_BOT_TOKEN=123:ABC \
            -e CALCOM_API_KEY=dummy \
            -e ADMIN_TELEGRAM_ID=1 \
            -e DATABASE_PATH=/tmp/telecalbot.db \
            telecalbot:ci \
            /app/.venv/bin/python -c "from app.database import db, run_migrations; run_migrations(db); print('migrations-ok')"
